From 2e02c5acec62420e88f590bfeb38b32d3401e836 Mon Sep 17 00:00:00 2001
From: Stephen Livingston <stephen.livingston@hlioengineering.com>
Date: Tue, 17 Aug 2021 13:48:09 -0400
Subject: [PATCH] Update device tree to use sdmmc3 for esp32.

---
 arch/arm/boot/dts/stm32mp157c-dk2.dts       |  1 +
 arch/arm/boot/dts/stm32mp157c-hlio-rcb.dtsi | 84 +++++++++++++++++++++
 2 files changed, 85 insertions(+)
 create mode 100644 arch/arm/boot/dts/stm32mp157c-hlio-rcb.dtsi

diff --git a/arch/arm/boot/dts/stm32mp157c-dk2.dts b/arch/arm/boot/dts/stm32mp157c-dk2.dts
index 1c894f288..799ae2eb0 100644
--- a/arch/arm/boot/dts/stm32mp157c-dk2.dts
+++ b/arch/arm/boot/dts/stm32mp157c-dk2.dts
@@ -11,6 +11,7 @@
 #include "stm32mp15-pinctrl.dtsi"
 #include "stm32mp15xxac-pinctrl.dtsi"
 #include "stm32mp15xx-dkx.dtsi"
+#include "stm32mp157c-hlio-rcb.dtsi"
 #include <dt-bindings/rtc/rtc-stm32.h>
 
 / {
diff --git a/arch/arm/boot/dts/stm32mp157c-hlio-rcb.dtsi b/arch/arm/boot/dts/stm32mp157c-hlio-rcb.dtsi
new file mode 100644
index 000000000..e75383f59
--- /dev/null
+++ b/arch/arm/boot/dts/stm32mp157c-hlio-rcb.dtsi
@@ -0,0 +1,84 @@
+// SPDX-License-Identifier: (GPL-2.0+ OR BSD-3-Clause)
+/*
+ * Copyright (C) Helios Technologies 2021 - All Rights Reserved
+ * Author: Stephen Livingston (stephen.livingston@hlioengineering.com)
+ * stm32mp157c-dk2-user.dtsi - Additions to STMicroelectronics supplied stm32mp157c-dk2.dts
+ * 
+ */
+
+/* ESP32 Module SDIO */
+&sdmmc3 {
+		pinctrl-names = "default", "opendrain", "sleep";
+		pinctrl-0 = <&sdmmc3_pins_mx>;
+		pinctrl-1 = <&sdmmc3_opendrain_pins_mx>;
+		pinctrl-2 = <&sdmmc3_sleep_pins_mx>;
+		bus-width = <4>;
+		vmmc-supply = <&v3v3>;
+		max-frequency = <400000>;
+//		st,neg-edge;
+//		non-removable;
+//		cap-sdio-irq;
+//		interrupts-extended = <&exti ?? IRQ_TYPE_LEVEL_HIGH>;
+		status = "okay";
+
+    /* USER CODE BEGIN sdmmc3 */
+    /* USER CODE END sdmmc3 */
+};
+
+&pinctrl {
+	u-boot,dm-pre-reloc;
+
+	sdmmc3_pins_mx: sdmmc3_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('F', 0, AF9)>, /* SDMMC3_D0 */
+					 <STM32_PINMUX('D', 7, AF10)>, /* SDMMC3_D3 */
+					 <STM32_PINMUX('F', 1, AF9)>, /* SDMMC3_CMD */
+					 <STM32_PINMUX('F', 4, AF9)>, /* SDMMC3_D1 */
+					 <STM32_PINMUX('F', 5, AF9)>; /* SDMMC3_D2 */
+			bias-pull-up;
+			drive-push-pull;
+			slew-rate = <1>;
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('G', 15, AF10)>; /* SDMMC3_CK */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <3>;
+		};
+	};
+
+	sdmmc3_opendrain_pins_mx: sdmmc3_opendrain_mx-0 {
+		pins1 {
+			pinmux = <STM32_PINMUX('F', 0, AF9)>, /* SDMMC3_D0 */
+					 <STM32_PINMUX('D', 7, AF10)>, /* SDMMC3_D3 */
+					 <STM32_PINMUX('F', 4, AF9)>, /* SDMMC3_D1 */
+					 <STM32_PINMUX('F', 5, AF9)>; /* SDMMC3_D2 */
+			bias-pull-up;
+			drive-push-pull;
+			slew-rate = <1>;
+		};
+		pins2 {
+			pinmux = <STM32_PINMUX('F', 1, AF9)>; /* SDMMC3_CMD */
+			bias-pull-up;
+			drive-open-drain;
+			slew-rate = <1>;
+		};
+		pins3 {
+			pinmux = <STM32_PINMUX('G', 15, AF10)>; /* SDMMC3_CK */
+			bias-disable;
+			drive-push-pull;
+			slew-rate = <3>;
+		};
+	};
+
+	sdmmc3_sleep_pins_mx: sdmmc3_sleep_mx-0 {
+		pins {
+			pinmux = <STM32_PINMUX('D', 1, ANALOG)>, /* SDMMC3_D0 */
+					 <STM32_PINMUX('D', 7, ANALOG)>, /* SDMMC3_D3 */
+					 <STM32_PINMUX('F', 1, ANALOG)>, /* SDMMC3_CMD */
+					 <STM32_PINMUX('F', 4, ANALOG)>, /* SDMMC3_D1 */
+					 <STM32_PINMUX('F', 5, ANALOG)>, /* SDMMC3_D2 */
+					 <STM32_PINMUX('G', 15, ANALOG)>; /* SDMMC3_CK */
+		};
+	};
+};
\ No newline at end of file
-- 
2.25.1

