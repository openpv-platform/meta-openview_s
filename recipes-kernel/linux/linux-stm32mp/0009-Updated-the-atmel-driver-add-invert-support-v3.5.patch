From 5d504f93d303ab54a2c37fa0abad8be43fdb55ad Mon Sep 17 00:00:00 2001
From: Stephen Livingston <stephen.livingston@hlioengineering.com>
Date: Wed, 24 Aug 2022 12:59:09 -0400
Subject: [PATCH] Updated the atmel driver to add support for the
 touchscreen-inverted-x and touchscreen-inverted-y parameters to invert the
 orientation of the touch for the corresponding axis.

---
 .../devicetree/bindings/input/atmel,maxtouch.yaml     |  8 ++++++++
 drivers/input/touchscreen/atmel_mxt_ts.c              | 11 +++++++++++
 2 files changed, 19 insertions(+)

diff --git a/Documentation/devicetree/bindings/input/atmel,maxtouch.yaml b/Documentation/devicetree/bindings/input/atmel,maxtouch.yaml
index 3ec579d63..8579b0bd1 100644
--- a/Documentation/devicetree/bindings/input/atmel,maxtouch.yaml
+++ b/Documentation/devicetree/bindings/input/atmel,maxtouch.yaml
@@ -83,6 +83,14 @@ properties:
   wakeup-source:
     type: boolean
 
+  touchscreen-inverted-x:
+    type: boolean
+    description: Invert the X axis on the touch driver
+
+  touchscreen-inverted-y:
+    type: boolean
+    description: Invert the Y axis on the touch driver
+
 required:
   - compatible
   - reg
diff --git a/drivers/input/touchscreen/atmel_mxt_ts.c b/drivers/input/touchscreen/atmel_mxt_ts.c
index ba80a2476..809e1fa56 100644
--- a/drivers/input/touchscreen/atmel_mxt_ts.c
+++ b/drivers/input/touchscreen/atmel_mxt_ts.c
@@ -417,6 +417,9 @@ struct mxt_data {
 	u8 crc_err_count;
 	bool is_resync_enabled;
 
+	bool touchscreen_inverted_x;
+	bool touchscreen_inverted_y;
+
 	/* Cached parameters from object table */
 	u16 T5_address;
 	u8 T5_msg_size;
@@ -1468,6 +1471,11 @@ static void mxt_proc_t100_message(struct mxt_data *data, u8 *message)
 	x = get_unaligned_le16(&message[2]);
 	y = get_unaligned_le16(&message[4]);
 	
+	if (data->touchscreen_inverted_x)
+		x = data->max_x - x;
+	if (data->touchscreen_inverted_y)
+		y = data->max_y - y;
+
 	/* Get other auxdata[] bytes if present */
 	
 	if (status & MXT_T100_DETECT) {
@@ -5189,6 +5197,9 @@ static int mxt_parse_device_properties(struct mxt_data *data)
 
 	data->is_resync_enabled = device_property_read_bool(dev, "resync-enabled");
 
+	data->touchscreen_inverted_x = device_property_read_bool(dev, "touchscreen-inverted-x");
+	data->touchscreen_inverted_y = device_property_read_bool(dev, "touchscreen-inverted-y");
+
 	return 0;
 }
 
-- 
2.25.1

