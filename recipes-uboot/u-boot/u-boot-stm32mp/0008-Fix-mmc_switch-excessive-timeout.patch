From 042bc2c2c04138a82de6d95daa33059991481d71 Mon Sep 17 00:00:00 2001
From: Steve Livingston <stephen.livingston@hlioengineering.com>
Date: Thu, 2 Mar 2023 12:03:44 -0500
Subject: [PATCH] Fix mmc_switch excessive timeout

---
 drivers/mmc/mmc.c | 7 +++++--
 1 file changed, 5 insertions(+), 2 deletions(-)

diff --git a/drivers/mmc/mmc.c b/drivers/mmc/mmc.c
index d3babbfeb1..673b832fab 100644
--- a/drivers/mmc/mmc.c
+++ b/drivers/mmc/mmc.c
@@ -819,15 +819,18 @@ static int __mmc_switch(struct mmc *mmc, u8 set, u8 index, u8 value,
 		return ret;
 
 	/*
-	 * In cases when not allowed to poll by using CMD13 or because we aren't
+	 * In cases when neither allowed to poll by using CMD13 nor are we
 	 * capable of polling by using mmc_wait_dat0, then rely on waiting the
 	 * stated timeout to be sufficient.
 	 */
-	if (ret == -ENOSYS || !send_status) {
+	if (ret == -ENOSYS && !send_status) {
 		mdelay(timeout_ms);
 		return 0;
 	}
 
+	if (!send_status)
+		return 0;
+
 	/* Finally wait until the card is ready or indicates a failure
 	 * to switch. It doesn't hurt to use CMD13 here even if send_status
 	 * is false, because by now (after 'timeout_ms' ms) the bus should be
-- 
2.25.1

