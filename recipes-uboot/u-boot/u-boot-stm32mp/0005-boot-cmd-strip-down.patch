From b7d6541ed1bf35bf058e994c37f2fc4e62f1f658 Mon Sep 17 00:00:00 2001
From: Alfredo Avila <alfredo.avila@hlioengineering.com>
Date: Fri, 2 Dec 2022 15:56:47 -0600
Subject: [PATCH] boot cmd strip down

---
 include/configs/stm32mp15_st_common.h | 43 +++++++++++++++++----------
 1 file changed, 28 insertions(+), 15 deletions(-)

diff --git a/include/configs/stm32mp15_st_common.h b/include/configs/stm32mp15_st_common.h
index c395f7f986..61488f018f 100644
--- a/include/configs/stm32mp15_st_common.h
+++ b/include/configs/stm32mp15_st_common.h
@@ -27,21 +27,34 @@
  * for nand or spi-nand boot, distro boot with ubifs on UBI partition
  * for nor boot, distro boot on SD card = mmc0 ONLY !
  */
-#define ST_STM32MP1_BOOTCMD "bootcmd_stm32mp=" \
-	"echo \"Boot over ${boot_device}${boot_instance}!\";" \
-	"if test ${boot_device} = serial || test ${boot_device} = usb;" \
-	"then stm32prog ${boot_device} ${boot_instance}; " \
-	"else " \
-		"run env_check;" \
-		"if test ${boot_device} = mmc;" \
-		"then env set boot_targets \"mmc${boot_instance}\"; fi;" \
-		"if test ${boot_device} = nand ||" \
-		  " test ${boot_device} = spi-nand ;" \
-		"then env set boot_targets ubifs0; fi;" \
-		"if test ${boot_device} = nor;" \
-		"then env set boot_targets mmc0; fi;" \
-		"run distro_bootcmd;" \
-	"fi;\0"
+// #define ST_STM32MP1_BOOTCMD "bootcmd_stm32mp=" \
+// 	"echo \"Boot over ${boot_device}${boot_instance}!\";" \
+// 	"if test ${boot_device} = serial || test ${boot_device} = usb;" \
+// 	"then stm32prog ${boot_device} ${boot_instance}; " \
+// 	"else " \
+// 		"run env_check;" \
+// 		"if test ${boot_device} = mmc;" \
+// 		"then env set boot_targets \"mmc${boot_instance}\"; fi;" \
+// 		"if test ${boot_device} = nand ||" \
+// 		  " test ${boot_device} = spi-nand ;" \
+// 		"then env set boot_targets ubifs0; fi;" \
+// 		"if test ${boot_device} = nor;" \
+// 		"then env set boot_targets mmc0; fi;" \
+// 		"run distro_bootcmd;" \
+// 	"fi;\0"
+
+
+/**
+ *	The Update to the STM32MP1 BOOTCMD strips down the inital script provided by ST.
+ *	The script now only checks if USB is set as the boot device, implying that you
+ *	need to flash the device, and then runs the stm32prog command to preform the flash
+ *	process. If that is not the case, it shortcuts the rest of the original script
+ *	and runs the final sysboot command which loads the kernel / Device Tree / and rootfs.
+ * 	This decreases the time in U-Boot by almost a full second.
+ */
+#define ST_STM32MP1_BOOTCMD "bootcmd_stm32mp=if test ${boot_device} = usb;then stm32prog ${boot_device} ${boot_instance}; fi;" \
+							"sysboot mmc 1:6 any ${scriptaddr} /extlinux/extlinux.conf\0"
+
 
 #undef CONFIG_EXTRA_ENV_SETTINGS
 #define CONFIG_EXTRA_ENV_SETTINGS \
